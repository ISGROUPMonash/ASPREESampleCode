@{
    ViewBag.Title = "Configuration";
    Layout = "~/Views/Shared/_LayoutNew.cshtml";

    var entitiesSubType = ViewBag.entitiesSubType;

    Aspree.Core.ViewModels.LoggedInUser LoggedInUser = new Aspree.Core.ViewModels.LoggedInUser();
    try { LoggedInUser = ViewBag.LoggedInUser as Aspree.Core.ViewModels.LoggedInUser; } catch (Exception exc) { }

}


@section NavBarLeft{
        <h3 class="text-themecolor m-b-0 m-t-0">@LoggedInUser.ProjectDisplayName</h3>
}
@section NavBarRight{

}
<div class="col-sm-12 col-md-12 col-lg-12">
    <div class="main-content TabCard">
        <div class="justify-content-lg-center">
            <div class="col-md-11">
                <div class="card">
                    <div class="card-body">
                        @Html.Partial("~/Views/Shared/ManageSystemAdminTools.cshtml")
                        <div class="tab-content tabcontent-border">
                            <div class="tab-pane active" id="manageentities" role="tabpanel">
                                <div class="p-20">
                                    <div class="row">
                                        <div class="col-sm-4 col-md-4 col-lg-3">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h3 class="card-title">Library</h3>
                                                    <h4 class="card-subtitle">Existing Variables</h4>
                                                </div><!-- /.card-header -->
                                                <div class="card-body">
                                                    <div class="pb-library-list-wrap">
                                                        <div class="list-menu-wrap">
                                                            <ul class="list-menu">
                                                                @foreach (var menu in Model.categories)
                                                                {
                                                                    <li class="list-dropdown">
                                                                        <a href="javascript:void(0);">@menu.CategoryName</a>
                                                                        <div class="list-submenu">
                                                                            <ul>
                                                                                @foreach (var subMenu in menu.Variables)
                                                                                {
                                                                                    <li>
                                                                                        <a href="javascript:void(0);" ondblclick="variableDblClick(event);" class="draggable">
                                                                                            @subMenu.Name <input type="hidden" id="subMenuHiddenVar" value="@subMenu.Guid" />   @if (!subMenu.IsApproved)
                                                                                            { <i> (draft)</i> }
                                                                                        </a>
                                                                                    </li>
                                                                                }
                                                                            </ul>
                                                                        </div>
                                                                    </li>
                                                                }
                                                            </ul>
                                                        </div><!-- /.list-menu-wrap -->
                                                    </div>
                                                </div><!-- /.card-body -->
                                            </div>
                                        </div>
                                        <div class="col-sm-8 col-md-8 col-lg-9">
                                            <div class="card">
                                                <div class="card-header">
                                                    Create a New Entity or Edit an Existing Entity
                                                </div>
                                                <div class="card-body">
                                                    <form id="roleForm" class="form-horizontal" method="post" action="/Entities/Configuration">
                                                        <input id="TenantId" name="TenantId" value="@Model.TenantId" type="hidden" />

                                                        <div class="form-group" style="display:none;">
                                                            <label for="EntityName" class="">Entity Name<span class="text-danger">*</span></label>
                                                            @*@Html.TextBox("EntityName", "", new { @class = "form-control", @required = "required", @maxlength = "30" })*@
                                                            <input type="text" id="EntityName" name="EntityName" required class="form-control" maxlength="30" />
                                                            @*@Html.ValidationMessage("EntityName", new { @class = "form-control-feedback" })*@
                                                        </div>

                                                        <div class="form-group">
                                                            <input type="hidden" name="Guid" id="Guid" value="@Model.entityData.Guid" />
                                                            <label for="EntityType" class="">Entity Type<span class="text-danger">*</span></label>
                                                            <select class="form-control" id="EntityType">
                                                                <option value="0">Entity Type</option>
                                                                @foreach (var item in Model.entities)
                                                                {
                                                                    if (item.Guid == Model.entityData.EntityTypeId)
                                                                    {
                                                                        <option value="@item.Guid" selected="selected">@item.Name</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@item.Guid">@item.Name</option>
                                                                    }

                                                                }
                                                            </select>
                                                               </div>

                                                        @{string displayType = "none";}
                                                        @if (Model.entityData.EntitySubTypeId != null)
                                                        {
                                                            displayType = "block";
                                                        }
                                                        <div class="form-group" id="divEntitySubtype" style="display:@displayType;">
                                                            <label for="EntitySubtype" class="">Entity Subtype<span class="text-danger">*</span></label>
                                                            <select id="EntitySubtype" class="form-control">
                                                                <option selected="true" disabled>Entity Subtype</option>

                                                                @foreach (var entitysubtype in entitiesSubType)
                                                                {
                                                                    if (entitysubtype.EntityTypeId == Model.entityData.EntityTypeId)
                                                                    {
                                                                        if (entitysubtype.Guid == Model.entityData.EntitySubTypeId)
                                                                        {
                                                                            <option value="@entitysubtype.Guid" selected="selected">@entitysubtype.Name</option>
                                                                        }
                                                                        else
                                                                        {
                                                                            <option value="@entitysubtype.Guid">@entitysubtype.Name</option>
                                                                        }
                                                                    }
                                                                }
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <div class="card">
                                                                <div class="card-header text-center">
                                                                    drag and drop pane
                                                                </div>
                                                                <div class="card-body" id="droppableDiv">
                                                                    <div id="droppedVariable" style="min-height:300px" class="row droppable">
                                                                        @{var i = 0; }
                                                                        @foreach (var variable in Model.entityData.EntityVariableList)
                                                                        {
                                                                            i++;
                                                                            <div class="col-md-12">
                                                                                <div class="form-group">
                                                                                    <div class="card">
                                                                                        <div class="card-body variable-card">
                                                                                            <input type="hidden" value="@variable.EntityVariableGuid" class="variable-guid" />
                                                                                            <label for="Question">
                                                                                                @variable.Question
                                                                                                @if (variable.IsRequired)
                                                                                                {
                                                                                                    <span class="text-danger">*</span>
                                                                                                }
                                                                                            </label>

                                                                                            <span type="button" title="Remove" onclick="$(this).parent().parent().parent().parent().remove()" class="btn btn-sm waves-effect waves-light btn-danger pull-right variable-card variable-card-remove">
                                                                                                <i class="far fa-times-circle"></i>
                                                                                            </span>

                                                                                            <br />

                                                                                            @if (variable.VariableType == "Free Text")
                                                                                            {
                                                                                                <input class='form-control form-control-sm answer-value' name='txtFreeText' value='' />
                                                                                            }
                                                                                            else if (variable.VariableType == "Dropdown")
                                                                                            {
                                                                                                <select class='form-control answer-value' name='QuestionType'>
                                                                                                    <option value='0'>Select</option>
                                                                                                    @foreach (var ddl in variable.VariableValueDescription)
                                                                                                    {
                                                                                                        <option value='@ddl'>@ddl</option>
                                                                                                    }
                                                                                                </select>
                                                                                            }
                                                                                            else if (variable.VariableType == "Checkbox")
                                                                                            {
                                                                                                foreach (var chk in variable.VariableValueDescription)
                                                                                                {
                                                                                                    <label class="custom-control custom-checkbox">
                                                                                                        <input type="checkbox" name='answerVal-@i' id='answerVal-@i' value="@chk" class="custom-control-input answer-value" />
                                                                                                        <span class="custom-control-label">@chk </span>
                                                                                                    </label>
                                                                                                }
                                                                                            }
                                                                                            else if (variable.VariableType == "Radio")
                                                                                            {
                                                                                                foreach (var radio in variable.VariableValueDescription)
                                                                                                {
                                                                                                    <label class="custom-control custom-radio">
                                                                                                        <input type="radio" name="answerVal-@i" id='answerVal-@i' value="@radio" class="custom-control-input answer-value" />
                                                                                                        <span class="custom-control-label">@radio </span>
                                                                                                    </label>
                                                                                                }
                                                                                            }
                                                                                            else if (variable.VariableType == "Numeric")
                                                                                            {
                                                                                                <input class='form-control form-control-sm answer-value' name='numericvalue' id='answerVal-@i' value='' />
                                                                                            }
                                                                                            else if (variable.VariableType == "Formula")
                                                                                            {
                                                                                                <input class='form-control form-control-sm ' name='formulavalue' id='answerVal-@i' value='' />
                                                                                            }
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <a href="/Entities/Configuration" class="btn btn-inverse waves-effect waves-light pull-right">Cancel</a>
                                                        @if (Model.entityData.Name != null)
                                                        {
                                                            <button type="button" onclick="Entity.save(true)" class="btn waves-effect waves-light btn-info pull-right m-r-10">Save</button>
                                                        }
                                                        else
                                                        {
                                                            <button type="button" onclick="Entity.save()" class="btn waves-effect waves-light btn-info pull-right m-r-10">Save</button>
                                                        }

                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Styles{
    <link href="/content/assets/plugins/ion-rangeslider/css/ion.rangeSlider.css" rel="stylesheet">
    <link href="/content/assets/plugins/ion-rangeslider/css/ion.rangeSlider.skinModern.css" rel="stylesheet">

    <link href="/content/assets/plugins/wizard/steps.css" rel="stylesheet">
    <link href="/content/assets/plugins/daterangepicker/daterangepicker.css" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        .variable-card {
            padding: 6px;
        }

        .variable-card-remove {
            margin-right: -5px;
            margin-top: -5px;
            padding-top: 1px;
            padding-bottom: 1px;
            padding-left: 4px;
            padding-right: 3px;
        }
    </style>
}

@section Scripts {
    <script src="/content/assets/plugins/ion-rangeslider/js/ion-rangeSlider/ion.rangeSlider.min.js"></script>
<script src="/content/assets/plugins/moment/moment.js"></script>
<script src="/content/assets/plugins/daterangepicker/daterangepicker.js"></script>

    @Scripts.Render("~/bundles/jqueryval")

    <script>
        $(function () {
            $(".list-dropdown > a").click(function () {
                $(".list-submenu").slideUp(200);
                if ($(this).parent().hasClass("active")) {
                    $(".list-dropdown").removeClass("active");
                    $(this).parent().removeClass("active");
                } else {
                    $(".list-dropdown").removeClass("active");
                    $(this).next(".list-submenu").slideDown(200);
                    $(this).parent().addClass("active");
                }
            });

            Entity.DateFormat = '@Aspree.Utility.ConfigSettings.DateFormat.ToUpper()'; // 'DD-MM-YYYY'
        });
    </script>
    <script>
        $(function () {
            $('.system-admin-tools li a').removeClass('active show');
            $('.system-admin-tools li a:eq(3)').addClass('active show');

            $('#sidebarnav > li').removeClass('active');
            $('#sidebarnav > li:nth-child(6)').addClass('active');
        })
    </script>
    @Scripts.Render("~/apps/entities")
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script>
    $('#EntityName').val('default');
     
    $('.draggable').draggable({
        revert: "invalid",
        stack: ".draggable",
        helper: 'clone'
    });
    $('.droppable').droppable({
        accept: ".draggable",
        drop: function (event, ui) {

            var droppable = $(this);
            var draggable = ui.draggable;
            var guid = draggable.context.childNodes[1].value;
            var alreadyDroppedVariablesList = getExistingVariables();
            if ($.inArray(guid, alreadyDroppedVariablesList) != -1) {
                return false;
            }

            DropVariable(guid);
        }
    });

    $(".droppable").sortable();
    $(".droppable").disableSelection();
 
    function DropVariable(guid) {
        App.postData(App.ApiUrl + 'Variable/' + guid, {}, function (data) {
            var middelcontent = "</br>";
            if (data.variableTypeName == "Free Text") {
                middelcontent = "<input class='form-control form-control-sm' name='typeNumeric' id='typeNumeric' value='' />";
            } else if (data.variableTypeName == "Dropdown") {

                var options = "";
                for (var i = 0; i < data.values.length; i++) {
                    options = options + "<option value='" + data.variableValueDescription[i] + "'>" + data.variableValueDescription[i] + "</option>";
                }
                middelcontent = "<div class='form-group' id='selectdropdownvalue'>" +
                     "<select class='form-control' id='QuestionType' name='QuestionType'>" +

                     "<option value='0'>Select</option>" +
                options +

                     "</select>" +
                     "</div>";
            } else if (data.variableTypeName == "Checkbox") {
                var options = "";
                for (var i = 0; i < data.values.length; i++) {
                    options = options + '<label class="custom-control custom-checkbox"><input type="checkbox" name="CheckboxValue" id="CheckboxValue" class="custom-control-input" checked=""/><span class="custom-control-label">' + data.variableValueDescription[i] + '</span></label>';
                }

                middelcontent = "<div class='form-group' id='selectcheckboxvalue'>" +
                    options +
                    "</div>";
            } else if (data.variableTypeName == "Radio") {
                var options = "";
                for (var i = 0; i < data.values.length; i++) {
                    options = options + '<label class="custom-control custom-radio"><input type="radio" name="RadioButtonValue" id="RadioButtonValue" value="{0}" class="custom-control-input"/><span class="custom-control-label">' + data.variableValueDescription[i] + '</span></label>';
                }

                middelcontent = "<div class='form-group' id='selectradiobuttonvalue'>" + options + "</div>";
            } else if (data.variableTypeName == "Numeric") {
                middelcontent = "<input class='form-control form-control-sm' name='numericvalue' id='numericvalue' value='' />";
            } else if (data.variableTypeName == "Formula") {
                middelcontent = "<input class='form-control form-control-sm' name='formulavalue' id='formulavalue' value='' />";
            }
            var isRequired = "";
            if (data.isRequired) {
                isRequired = "<span class='text-danger'>*</span>";
            }
            var dropableDiv = "<div class='col-md-12'><div class='form-group'><div class='card'>" +
                                    "<div class='card-body variable-card'>" + //text-center
                                    "<span type='button' title='Remove' onclick='$(this).parent().parent().parent().parent().remove()' class='btn btn-sm waves-effect waves-light btn-danger pull-right variable-card variable-card-remove'>" +
                                        "<i class='far fa-times-circle'></i>" +
                                    "</span>" +
                                    "<input type='hidden' value='" + guid + "' class='variable-guid' />" +
                                    data.question + isRequired +
                                    "</br>" +
                                        middelcontent +
                                    "</div>" +
                                "</div></div></div>";
            $('#droppedVariable').append(dropableDiv);
        }, "GET");
    }

    function variableDblClick(e) {
        var guid = e.currentTarget.childNodes[1].value;
        var alreadyDroppedVariablesList = getExistingVariables();
        if ($.inArray(guid, alreadyDroppedVariablesList) != -1) {
            return false;
        }
        DropVariable(guid)
    }
    function getExistingVariables() {
        var guids = [];
        $(".variable-guid").each(function () {
            guids.push($(this).val());
        });
        return guids;
    }
</script>